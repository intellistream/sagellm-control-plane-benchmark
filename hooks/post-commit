#!/usr/bin/env bash
# Post-commit hook for sageLLM repositories
# Automatically bumps BUILD version (X.Y.Z.BUILD ‚Üí X.Y.Z.BUILD+1) after each commit.
# Version source of truth: src/<package>/_version.py
#
# This runs AFTER commit, amends it with the bumped version,
# so the pre-push hook never needs to handle version bumping.

set -eo pipefail

# Recursion guard: skip if we're already inside an amend
if [ -f ".git/SAGE_POST_COMMIT_RUNNING" ]; then
    exit 0
fi

# Allow disabling via environment variable
if [ "${SAGE_SKIP_VERSION_BUMP:-0}" = "1" ]; then
    exit 0
fi

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Bump BUILD digit: X.Y.Z.N ‚Üí X.Y.Z.(N+1), X.Y.Z ‚Üí X.Y.Z.1
bump_version() {
    local v="$1"
    if [[ "$v" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
        echo "${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}.$((BASH_REMATCH[4] + 1))"
        return 0
    fi
    if [[ "$v" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
        echo "${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}.1"
        return 0
    fi
    return 1
}

# Find _version.py ‚Äî single source of truth
find_version_file() {
    find src -maxdepth 4 -name '_version.py' \
        -not -path '*/.git/*' \
        -not -path '*/dist/*' \
        -not -path '*/.egg-info/*' \
        -not -path '*/build/*' \
        2>/dev/null | head -1
}

VERSION_FILE=$(find_version_file)
if [ -z "$VERSION_FILE" ]; then
    exit 0  # Not a Python package repo, nothing to do
fi

# Check if _version.py was already changed in this commit
if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q '_version.py'; then
    exit 0  # Developer manually bumped version, don't override
fi

# Read current version from _version.py
current_version=$(grep -oP '__version__ = "\K[^"]+' "$VERSION_FILE" 2>/dev/null || true)
if [ -z "$current_version" ]; then
    exit 0
fi

# Calculate new version
if ! new_version=$(bump_version "$current_version"); then
    echo -e "${YELLOW}‚ö†Ô∏è  Could not auto-bump version (invalid format: $current_version)${NC}"
    exit 0
fi

echo -e "${BLUE}üì¶ Auto-bumping version: $current_version ‚Üí $new_version${NC}"

# Lock to prevent recursion
touch .git/SAGE_POST_COMMIT_RUNNING

# Update _version.py (single source of truth)
sed -i "s/__version__ = \"${current_version}\"/__version__ = \"${new_version}\"/" "$VERSION_FILE"
git add "$VERSION_FILE"

# Amend commit with version bump (--no-verify to skip re-triggering hooks)
git commit --amend --no-edit --no-verify

# Cleanup
rm -f .git/SAGE_POST_COMMIT_RUNNING

echo -e "${GREEN}‚úì Version bumped to $new_version (commit amended)${NC}"
exit 0
